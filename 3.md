
该文档是《Spring Cloud 微服务项目实战》课程的第三讲，主要介绍实战项目的整体规划，包括业务功能、模块划分、技术选型及分阶段的微服务改造流程。以下是详细讲解：


### **一、实战项目背景与业务功能**
#### 1. **项目定位**
- **目标**：搭建一个简化版的**电商优惠券平台**，实现优惠券的全生命周期管理及优惠计算功能，模拟一线电商营销场景（如双11、618大促）。
- **业务场景**：参考真实电商经验，基于“模板化”设计实现优惠券的创建、领取、核销及优惠计算，抽象通用规则（如满减、打折、随机立减等），提升灵活性和复用性。

#### 2. **核心功能模块**
| **模块名称**       | **功能描述**                                                                 |
|--------------------|-----------------------------------------------------------------------------|
| **优惠券模板服务** | 创建、克隆、查询优惠券模板（如满减、满折、晚间双倍优惠等规则），定义优惠计算公式。 |
| **优惠计算服务**   | 根据用户购物车信息和优惠券，计算订单优惠后价格；支持多券“试算”，推荐最优优惠方案。 |
| **用户服务**       | 对外暴露用户接口，实现领券、订单试算、下单核销等功能，依赖前两个基础服务。     |
| **平台类组件**     | 提供微服务基础设施（如网关、链路追踪、配置中心等），支持横向功能扩展。         |

#### 3. **模块交互关系**
- **用户服务**作为入口，调用**模板服务**获取优惠券规则，调用**计算服务**完成价格计算；
- **平台类组件（如Gateway、Nacos）**负责流量路由、服务注册与发现、配置管理等底层支持；
- **架构图示例**：  
  ```
  用户 → 用户服务 → [调用] 模板服务/计算服务 → 平台组件（网关、注册中心等）
  ```


### **二、项目实施路径：从Spring Boot到Spring Cloud**
#### 1. **第一阶段：Spring Boot单体应用搭建**
- **目标**：快速实现业务逻辑，为微服务化改造奠定基础。
- **技术选型**：
  - **框架**：Spring Boot，简化配置，快速开发；
  - **数据层**：Spring Data JPA，通过接口声明、自定义SQL等方式实现数据库CRUD；
  - **接口层**：Spring Web，开发RESTful API；
  - **项目结构**：分层架构（如Controller、Service、Repository），Maven管理依赖。
- **关键任务**：
  - 搭建“超级单体应用”，将模板服务、计算服务、用户服务打包为一个应用，通过本地方法调用实现模块交互；
  - 掌握防御型编程、数据校验、JPA级联操作等实战技巧。

#### 2. **第二阶段：Spring Cloud微服务化改造**
- **目标**：将单体应用拆分为独立微服务，引入分布式组件实现核心功能。
- **技术选型与阶段划分**：

##### **阶段1：基础通信与服务治理**
- **核心组件**：
  - **Nacos**：服务注册与发现中心，替代Netflix Eureka，管理微服务地址；
  - **Loadbalancer**：客户端负载均衡器，替代Ribbon，实现流量分配；
  - **OpenFeign**：简化HTTP远程调用，实现服务间通信（如用户服务调用模板服务）。
- **实施步骤**：
  1. 将三个业务模块拆分为独立微服务，注册到Nacos；
  2. 使用Loadbalancer实现负载均衡，自定义扩展接口实现金丝雀测试；
  3. 用OpenFeign替换原始的WebClient调用，简化代码。

##### **阶段2：服务容错与链路追踪**
- **核心组件**：
  - **Sentinel**：流量控制与服务容错，实现限流、熔断、降级（如保护计算服务免受高并发冲击）；
  - **Nacos Config**：分布式配置中心，统一管理微服务配置，支持动态推送；
  - **Sleuth+Zipkin+ELK**：链路追踪与日志系统，串联跨服务调用链，定位线上问题。
- **实施步骤**：
  1. 接入Nacos Config，实现配置远程管理；
  2. 集成Sentinel Dashboard，配置流量规则和降级策略；
  3. 搭建ELK（Elasticsearch+Logstash+Kibana），实现日志检索和调用链可视化。

##### **阶段3：网关、消息驱动与分布式事务**
- **核心组件**：
  - **Spring Cloud Gateway**：微服务网关，作为流量入口，实现路由转发、拦截器逻辑（如权限校验）；
  - **Spring Cloud Stream+RabbitMQ**：消息驱动组件，解耦微服务（如用户领券后异步通知模板服务更新状态）；
  - **Seata**：分布式事务解决方案，支持AT（无侵入）和TCC（补偿型）模式，解决跨服务数据一致性问题（如领券与库存扣减事务）。
- **实施步骤**：
  1. 部署Gateway，配置路由规则和谓词（如按路径、请求头路由）；
  2. 集成RabbitMQ，通过Stream实现消息发送与消费；
  3. 使用Seata解决分布式事务场景（如用户下单时同时更新订单和优惠券状态）。


### **三、技术选型背后的逻辑**
#### 1. **弃用Netflix组件的原因**
- **维护状态**：Eureka、Ribbon、Hystrix等核心组件停止更新，无法适应新需求（如高并发、云原生）；
- **社区转向**：Spring Cloud官方推动“去Netflix化”，优先支持自研（如Gateway）和活跃组件（如Alibaba Nacos、Sentinel）。

#### 2. **选择Alibaba组件的优势**
- **功能全面**：Nacos集成注册中心与配置中心，Sentinel一站式解决流量管理，Seata提供分布式事务方案，减少组件拼接成本；
- **实战验证**：经阿里双11等大促场景验证，稳定性和性能可靠；
- **生态活跃**：社区更新频繁，文档和案例丰富，适合企业级项目。

#### 3. **版本与工具建议**
- **避免盲目追新**：优先使用稳定的Release版本（如Nacos 2.x、Sentinel 1.8+），避免Snapshot或早期Milestone版本；
- **开发工具**：结合Google、Stack Overflow查询解决方案，提升英文技术文档阅读能力；
- **扩展学习**：后续课程将加餐容器化（如Docker）、Kubernetes部署等内容，完善微服务落地全流程。


### **四、项目全景架构图**
```mermaid
graph LR
    用户 --> Gateway((Spring Cloud Gateway))
    Gateway -->|路由转发| Nacos((Nacos注册中心))
    Nacos -->|服务发现| 模板服务((优惠券模板服务))
    Nacos -->|服务发现| 计算服务((优惠计算服务))
    Nacos -->|服务发现| 用户服务((用户服务))
    模板服务 -->|Feign调用| 计算服务
    用户服务 -->|Feign调用| 模板服务
    用户服务 -->|Feign调用| 计算服务
    subgraph 平台组件
        Nacos Config((Nacos配置中心))
        Sentinel((Sentinel控制台))
        ELK((ELK日志系统))
        RabbitMQ((RabbitMQ消息队列))
        Seata((Seata事务协调器))
    end
    模板服务 --> Nacos Config
    计算服务 --> Nacos Config
    用户服务 --> Nacos Config
    模板服务 --> Sentinel
    计算服务 --> Sentinel
    用户服务 --> Sentinel
    模板服务 --> ELK
    计算服务 --> ELK
    用户服务 --> ELK
    用户服务 --> RabbitMQ
    模板服务 --> Seata
    计算服务 --> Seata
```


### **五、学习建议与后续展望**
#### 1. **学习路径**
- **按阶段推进**：避免跳章节，前一阶段是后一阶段的基础（如先完成服务注册，再实现容错）；
- **动手实践**：跟随课程代码（Gitee地址：[优惠券平台源码](https://gitee.com/banxian-yao/geekbang-coupon-center)），逐步调试组件配置和调用逻辑。

#### 2. **延伸思考**
- **技术扩展**：用户提出希望学习ID生成器、容器化部署等内容，后续将通过加餐补充；
- **思考题**：结合项目场景，思考如何设计高并发下的优惠券发放策略（如限流、库存预扣），或分布式锁在防重复领券中的应用。

通过以上规划，课程将逐步带领读者从单体应用过渡到完整的微服务架构，覆盖开发、测试、部署全流程，帮助掌握Spring Cloud Alibaba的核心实战能力。
